<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris SKB Muara Badak</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.hidden{display:none}
header{background:#1e40af;color:white;padding:12px;display:flex;align-items:center;justify-content:space-between}
header img{height:45px}
.container{padding:20px}
.card{background:white;padding:15px;border-radius:10px;margin-bottom:15px;box-shadow:0 4px 8px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse}
th,td{border:1px solid #444;padding:5px;font-size:13px;text-align:center}
th{background:#9bbb59}
input,select,button{padding:6px;margin:4px;width:100%}
button{border:none;border-radius:6px;cursor:pointer}
.primary{background:#2563eb;color:white}
.success{background:#16a34a;color:white}
.danger{background:#dc2626;color:white}
.menu{display:flex;gap:8px;flex-wrap:wrap}

#loginBox{max-width:420px;margin:60px auto;background:white;padding:30px;border-radius:12px;text-align:center}
#loginBox img{height:90px}

/* ===== CETAK LANDSCAPE ===== */
@media print{
  @page{size:A4 landscape;margin:1cm}
  header,.menu,button,#loginBox{display:none!important}
  body{background:white}
}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
  <img src="logo.png">
  <h3>Inventaris SKB Muara Badak</h3>
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button class="primary" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
  <div style="display:flex;align-items:center;gap:10px">
    <img src="logo.png">
    <b>Dashboard Inventaris</b>
  </div>
  <button class="danger" onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="menu card">
  <button class="primary" onclick="showForm('masuk')">Barang Masuk</button>
  <button class="danger" onclick="showForm('keluar')">Barang Keluar</button>
  <button class="success" onclick="window.print()">ðŸ–¨ Cetak</button>
  <button class="primary" onclick="downloadExcel()">â¬‡ Download Excel</button>
</div>

<!-- BARANG MASUK -->
<div class="card hidden" id="masuk">
<h3>Barang Masuk</h3>
<input id="mBarang" placeholder="Nama Barang">
<select id="mJenis">
<option>Barang Modal</option>
<option>BAJAS</option>
</select>
<select id="mDana">
<option>BOSKAB 1</option>
<option>BOSKAB 2</option>
<option>BOP 1</option>
<option>BOP 2</option>
<option>Dana Lainnya</option>
</select>
<input type="number" id="mJumlah" placeholder="Jumlah">
<select id="mSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>unit</option>
</select>
<button class="success" onclick="barangMasuk()">Simpan</button>
</div>

<!-- BARANG KELUAR -->
<div class="card hidden" id="keluar">
<h3>Barang Keluar</h3>
<select id="kBarang"></select>
<input type="number" id="kJumlah" placeholder="Jumlah">
<select id="kSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>unit</option>
</select>
<select id="kAmbil">
<option>Bu Munawarah. S.Pd</option>
<option>Bu Liliana Sataria. S.Kom</option>
<option>Bu Fatimah. S.Pd</option>
<option>Bu Fitriyana. S.Pd</option>
<option>Bu Hirda Yulinalmi</option>
<option>Bu Dwi Rika. S.Pd</option>
<option>Bu Uut</option>
<option>Pak Heri Sadiman. S.Pd</option>
<option>Pak Jemidin. S.Pd., M.Pd</option>
<option>Pak Rehan</option>
</select>
<button class="danger" onclick="barangKeluar()">Simpan</button>
</div>

<!-- TABEL -->
<div class="card">
<h3>Data Inventaris (Padat)</h3>
<table id="tabel"></table>
</div>

</div>
</div>

<script>
const akun=[{u:'admin',p:'123'},{u:'operator',p:'123'}];
let data = JSON.parse(localStorage.getItem('inv')) || [];

/* ===== LOGIN ===== */
function login(){
  if(!akun.find(a=>a.u===user.value && a.p===pass.value))
    return alert('Login gagal');
  loginBox.style.display='none';
  app.classList.remove('hidden');
  render();
}
function logout(){
  app.classList.add('hidden');
  loginBox.style.display='block';
}

/* ===== FORM ===== */
function showForm(id){
  masuk.classList.add('hidden');
  keluar.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

/* ===== STOK ===== */
function stok(barang){
  let m=0,k=0;
  data.forEach(d=>{
    if(d.barang===barang){
      if(d.tipe==='Masuk') m+=d.jumlah;
      if(d.tipe==='Keluar') k+=d.jumlah;
    }
  });
  return m-k;
}

/* ===== BARANG MASUK ===== */
function barangMasuk(){
  if(!mBarang.value||!mJumlah.value) return alert('Lengkapi data');
  data.push({
    tanggal:new Date().toLocaleDateString('id-ID'),
    tipe:'Masuk',
    barang:mBarang.value,
    jumlah:+mJumlah.value,
    satuan:mSatuan.value,
    jenis:mJenis.value,
    dana:mDana.value,
    pengambilan:''
  });
  localStorage.setItem('inv',JSON.stringify(data));
  mBarang.value=''; mJumlah.value='';
  render();
}

/* ===== BARANG KELUAR ===== */
function barangKeluar(){
  if(kJumlah.value > stok(kBarang.value))
    return alert('Stok tidak cukup');
  data.push({
    tanggal:new Date().toLocaleDateString('id-ID'),
    tipe:'Keluar',
    barang:kBarang.value,
    jumlah:+kJumlah.value,
    satuan:kSatuan.value,
    jenis:'',
    dana:'',
    pengambilan:kAmbil.value
  });
  localStorage.setItem('inv',JSON.stringify(data));
  kJumlah.value='';
  render();
}

/* ===== RENDER TABEL PADAT ===== */
function render(){
  // dropdown barang keluar
  kBarang.innerHTML='';
  [...new Set(data.map(d=>d.barang))].forEach(b=>{
    kBarang.innerHTML+=`<option>${b}</option>`;
  });

  let html=`
<tr>
<th>Tanggal</th>
<th>Nama Barang</th>
<th>Masuk</th>
<th>Keluar</th>
<th>Sisa</th>
<th>Pengambil</th>
<th>Keterangan</th>
</tr>`;
  data.forEach(d=>{
    html+=`
<tr>
<td>${d.tanggal||''}</td>
<td>${d.barang}</td>
<td>${d.tipe==='Masuk'?d.jumlah:''}</td>
<td>${d.tipe==='Keluar'?d.jumlah:''}</td>
<td>${stok(d.barang)}</td>
<td>${d.tipe==='Keluar'?d.pengambilan:''}</td>
<td>${d.jenis||''} ${d.dana||''}</td>
</tr>`;
  });
  tabel.innerHTML=html;
}

/* ===== DOWNLOAD EXCEL ===== */
function downloadExcel(){
  const fDana = document.getElementById('filterDana').value;
  const fJenis = document.getElementById('filterJenis').value;

  let map = {};

  data.forEach(d=>{
    // filter hanya saat download
    if(fDana && d.dana !== fDana) return;
    if(fJenis && d.jenis !== fJenis) return;

    if(!map[d.barang]){
      map[d.barang] = {Barang:d.barang, Masuk:0, Keluar:0};
    }
    if(d.tipe==='Masuk') map[d.barang].Masuk += d.jumlah;
    if(d.tipe==='Keluar') map[d.barang].Keluar += d.jumlah;
  });

  let hasil = [];
  for(let b in map){
    hasil.push({
      Barang: b,
      Masuk: map[b].Masuk,
      Keluar: map[b].Keluar,
      Sisa: map[b].Masuk - map[b].Keluar
    });
  }

  if(!hasil.length){
    alert('Data tidak ditemukan sesuai pilihan');
    return;
  }

  const ws = XLSX.utils.json_to_sheet(hasil);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Rekap');

  let namaFile = `Inventaris_${fDana||'SEMUA'}_${fJenis||'SEMUA'}.xlsx`;
  XLSX.writeFile(wb, namaFile);
}


render();
</script>

</body>
</html>
