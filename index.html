<script>
const akun = [
  {u:'admin', p:'123'},
  {u:'operator', p:'123'}
];

let data = JSON.parse(localStorage.getItem('inventaris')) || [];

/* ================= LOGIN ================= */
document.getElementById('loginBtn').onclick = () => {
  let u = user.value;
  let p = pass.value;
  if(!akun.find(a => a.u===u && a.p===p)) {
    alert('Login gagal');
    return;
  }
  loginBox.classList.add('hidden');
  app.classList.remove('hidden');
  render();
};

document.getElementById('logoutBtn').onclick = () => {
  app.classList.add('hidden');
  loginBox.classList.remove('hidden');
};

/* ================= MENU ================= */
function show(id){
  masuk.classList.add('hidden');
  keluar.classList.add('hidden');
  document.getElementById(id).classList.remove('hidden');
}

/* ================= STOK ================= */
function stok(barang){
  let masuk = 0, keluar = 0;
  data.forEach(d=>{
    if(d.barang===barang && d.tipe==='Masuk') masuk+=d.jumlah;
    if(d.barang===barang && d.tipe==='Keluar') keluar+=d.jumlah;
  });
  return masuk - keluar;
}

/* ================= BARANG MASUK ================= */
function masukBarang(){
  if(!mBarang.value || !mJumlah.value) return alert('Lengkapi data');
  data.push({
    tipe:'Masuk',
    barang:mBarang.value,
    jenis:mJenis.value,
    dana:mDana.value,
    jumlah:+mJumlah.value,
    satuan:mSatuan.value
  });
  simpan();
}

/* ================= BARANG KELUAR ================= */
function keluarBarang(){
  if(kJumlah.value > stok(kBarang.value)){
    alert('Stok tidak mencukupi');
    return;
  }
  data.push({
    tipe:'Keluar',
    barang:kBarang.value,
    jenis:kJenis.value,
    dana:kDana.value,
    jumlah:+kJumlah.value,
    satuan:kSatuan.value,
    ambil:kAmbil.value
  });
  simpan();
}

/* ================= SIMPAN ================= */
function simpan(){
  localStorage.setItem('inventaris', JSON.stringify(data));
  render();
}

/* ================= HAPUS ================= */
function hapus(i){
  if(confirm('Hapus data?')){
    data.splice(i,1);
    simpan();
  }
}

/* ================= RENDER ================= */
function render(){

  /* dropdown barang keluar */
  kBarang.innerHTML = '';
  [...new Set(data.filter(d=>d.tipe==='Masuk').map(d=>d.barang))]
  .forEach(b=>kBarang.innerHTML+=`<option>${b}</option>`);

  /* dropdown jenis & dana */
  kJenis.innerHTML='';
  kDana.innerHTML='';
  fJenisDownload.innerHTML='<option value="">Semua Jenis</option>';
  fDanaDownload.innerHTML='<option value="">Semua Dana</option>';

  [...new Set(data.map(d=>d.jenis))].forEach(j=>{
    if(j){
      kJenis.innerHTML+=`<option>${j}</option>`;
      fJenisDownload.innerHTML+=`<option>${j}</option>`;
    }
  });

  [...new Set(data.map(d=>d.dana))].forEach(d=>{
    if(d){
      kDana.innerHTML+=`<option>${d}</option>`;
      fDanaDownload.innerHTML+=`<option>${d}</option>`;
    }
  });

  /* rekap */
  let r='<tr><th>Barang</th><th>Sisa</th></tr>';
  [...new Set(data.map(d=>d.barang))].forEach(b=>{
    r+=`<tr><td>${b}</td><td>${stok(b)}</td></tr>`;
  });
  rekap.innerHTML=r;

  /* tabel data */
  let t='<tr><th>No</th><th>Tipe</th><th>Barang</th><th>Jenis</th><th>Dana</th><th>Jumlah</th><th>Satuan</th><th>Aksi</th></tr>';
  data.forEach((d,i)=>{
    t+=`<tr>
      <td>${i+1}</td>
      <td>${d.tipe}</td>
      <td>${d.barang}</td>
      <td>${d.jenis||''}</td>
      <td>${d.dana||''}</td>
      <td>${d.jumlah}</td>
      <td>${d.satuan}</td>
      <td><button class="danger" onclick="hapus(${i})">Hapus</button></td>
    </tr>`;
  });
  tabel.innerHTML=t;
}

/* ================= DOWNLOAD ================= */
function downloadFilteredExcel(){
  let hasil = data.filter(d=>{
    if(fTipe.value && d.tipe!==fTipe.value) return false;
    if(fJenisDownload.value && d.jenis!==fJenisDownload.value) return false;
    if(fDanaDownload.value && d.dana!==fDanaDownload.value) return false;
    return true;
  });

  let ws = XLSX.utils.json_to_sheet(hasil);
  let wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Inventaris');
  XLSX.writeFile(wb, 'Inventaris_SKB.xlsx');
}
</script>

</body>
</html>
