<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris SKB Muara Badak</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.hidden{display:none}
header{background:#1e40af;color:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
header img{height:45px;margin-right:15px}
.container{padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#e5e7eb}
input,select,button{padding:8px;margin:4px;width:100%}
button{cursor:pointer;border:none;border-radius:6px}
.primary{background:#2563eb;color:white}
.danger{background:#dc2626;color:white}
.success{background:#16a34a;color:white}
.menu{display:flex;gap:10px;flex-wrap:wrap}
#loginBox{max-width:420px;margin:60px auto;background:#fff;padding:30px;border-radius:12px;text-align:center}
#loginBox img{height:90px;margin-bottom:10px}
.logoutBtn{background:#f59e0b;color:white;padding:8px;border:none;border-radius:6px;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
<img src="logo.png">
<h3>Inventaris SKB Muara Badak</h3>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button class="primary" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
<div style="display:flex;align-items:center">
<img src="logo.png">
<h3>Dashboard Inventaris</h3>
</div>
<button class="logoutBtn" onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="card menu">
<button class="primary" onclick="show('masuk')">Barang Masuk</button>
<button class="danger" onclick="show('keluar')">Barang Keluar</button>
</div>

<!-- BARANG MASUK -->
<div class="card hidden" id="masuk">
<h3>Barang Masuk</h3>
<input id="mBarang" placeholder="Nama Barang">

<select id="mJenis">
<option>Barang Modal</option>
<option>BAJAS</option>
</select>

<select id="mDana">
<option>BOSKAB 1</option>
<option>BOSKAB 2</option>
<option>BOP 1</option>
<option>BOP 2</option>
<option>Dana Lainnya</option>
</select>

<input type="number" id="mJumlah" placeholder="Jumlah">

<select id="mSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>lusin</option>
<option>Botol</option><option>Paket</option>
<option>Unit</option><option>Meter</option>
</select>

<button class="success" onclick="masukBarang()">Simpan</button>
</div>

<!-- BARANG KELUAR -->
<div class="card hidden" id="keluar">
<h3>Barang Keluar</h3>

<select id="kBarang"></select>
<input type="number" id="kJumlah" placeholder="Jumlah">

<select id="kSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>lusin</option>
<option>Botol</option><option>Paket</option>
<option>Unit</option><option>Meter</option>
</select>

<select id="kJenis"></select>
<select id="kDana"></select>

<select id="kAmbil">
<option>Bu Munawarah. S.Pd</option>
<option>Bu Liliana Sataria. S.Kom</option>
<option>Bu Fatimah. S.Pd</option>
<option>Bu Fitriyana. S.Pd</option>
<option>Bu Hirda Yulinalmi</option>
<option>Bu Dwi Rika. S.Pd</option>
<option>Bu Uut</option>
<option>Pak Heri Sadiman. S.Pd</option>
<option>Pak Jemidin. S.Pd., M.Pd</option>
<option>Pak Rehan</option>
</select>

<button class="danger" onclick="keluarBarang()">Simpan</button>
</div>

<!-- REKAP -->
<div class="card">
<h3>Rekap Stok</h3>
<table id="rekap"></table>
</div>

<!-- DATA -->
<div class="card">
<h3>Data Inventaris</h3>
<table id="tabel"></table>
</div>

<!-- DOWNLOAD -->
<script>
function downloadExcel(){

const filtered = data.filter(d =>
 (!fJenis.value || d.jenis === fJenis.value) &&
 (!fDana.value || d.dana === fDana.value)
);

if(!filtered.length){
 alert('Data kosong');
 return;
}

const masuk  = filtered.filter(d=>d.tipe==='Masuk');
const keluar = filtered.filter(d=>d.tipe==='Keluar');

let ws = XLSX.utils.aoa_to_sheet([]);

/* =====================
   TABEL BARANG MASUK
===================== */
XLSX.utils.sheet_add_aoa(ws,[
 ['DATA BARANG MASUK'],
 ['No','Nama Barang','Jumlah','Satuan','Jenis','Sumber Dana','Tanggal']
],{origin:'A1'});

masuk.forEach((d,i)=>{
 XLSX.utils.sheet_add_aoa(ws,[[
  i+1,d.barang,d.jumlah,d.satuan,d.jenis,d.dana,d.tanggal
 ]],{origin:-1});
});

/* =====================
   TABEL BARANG KELUAR
===================== */
let startKeluar = masuk.length + 4;

XLSX.utils.sheet_add_aoa(ws,[
 [''],
 ['DATA BARANG KELUAR'],
 ['No','Nama Barang','Jumlah','Satuan','Jenis','Sumber Dana','Pengambil','Tanggal']
],{origin:'A'+startKeluar});

keluar.forEach((d,i)=>{
 XLSX.utils.sheet_add_aoa(ws,[[
  i+1,d.barang,d.jumlah,d.satuan,d.jenis,d.dana,d.pengambilan,d.tanggal
 ]],{origin:-1});
});

/* =====================
   REKAP SISA
===================== */
let map={};
filtered.forEach(d=>{
 let k=d.barang+'|'+d.jenis+'|'+d.dana;
 if(!map[k]) map[k]={barang:d.barang,jenis:d.jenis,dana:d.dana,masuk:0,keluar:0};
 if(d.tipe==='Masuk')  map[k].masuk  += d.jumlah;
 if(d.tipe==='Keluar') map[k].keluar += d.jumlah;
});

XLSX.utils.sheet_add_aoa(ws,[
 [''],
 ['REKAP SISA BARANG'],
 ['Barang','Jenis','Dana','Total Masuk','Total Keluar','Sisa']
],{origin:-1});

Object.values(map).forEach(r=>{
 XLSX.utils.sheet_add_aoa(ws,[[
  r.barang,r.jenis,r.dana,r.masuk,r.keluar,r.masuk-r.keluar
 ]],{origin:-1});
});

/* =====================
   EXPORT
===================== */
let wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Inventaris');
XLSX.writeFile(wb,'Inventaris_SKB_Muara_Badak.xlsx');
}
</script>


/* UPDATE */
function updateAll(){
updateDropdown();
updateRekap();
updateTabel();
updateFilter();
}

function updateDropdown(){
kBarang.innerHTML='';
kJenis.innerHTML='';
kDana.innerHTML='';
[...new Set(data.map(d=>d.barang))].forEach(v=>kBarang.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.jenis))].forEach(v=>kJenis.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.dana))].forEach(v=>kDana.innerHTML+=`<option>${v}</option>`);
}

function updateRekap(){
let r='<tr><th>Barang</th><th>Jenis</th><th>Dana</th><th>Sisa</th></tr>';
let map={};
data.forEach(d=>{
let k=d.barang+'|'+d.jenis+'|'+d.dana;
if(!map[k]){
map[k]=true;
r+=`<tr><td>${d.barang}</td><td>${d.jenis}</td><td>${d.dana}</td><td>${stok(d.barang,d.jenis,d.dana)}</td></tr>`;
}
});
rekap.innerHTML=r;
}

function updateTabel(){
let t='<tr><th>No</th><th>Tipe</th><th>Barang</th><th>Jumlah</th><th>Satuan</th><th>Jenis</th><th>Dana</th><th>Pengambilan</th></tr>';
data.forEach((d,i)=>{
t+=`<tr><td>${i+1}</td><td>${d.tipe}</td><td>${d.barang}</td><td>${d.jumlah}</td><td>${d.satuan}</td><td>${d.jenis}</td><td>${d.dana}</td><td>${d.pengambilan||'-'}</td></tr>`;
});
tabel.innerHTML=t;
}

function updateFilter(){
fJenis.innerHTML='<option value="">Semua Jenis</option>';
fDana.innerHTML='<option value="">Semua Dana</option>';
[...new Set(data.map(d=>d.jenis))].forEach(v=>fJenis.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.dana))].forEach(v=>fDana.innerHTML+=`<option>${v}</option>`);
}

/* DOWNLOAD EXCEL + REKAP */
function downloadExcel(){
let filtered=data.filter(d=>
(!fTipe.value||d.tipe===fTipe.value)&&
(!fJenis.value||d.jenis===fJenis.value)&&
(!fDana.value||d.dana===fDana.value)
);
if(!filtered.length) return alert('Data kosong');

let table=filtered.map((d,i)=>({
No:i+1,Tipe:d.tipe,Barang:d.barang,Jumlah:d.jumlah,
Satuan:d.satuan,Jenis:d.jenis,Dana:d.dana,Pengambilan:d.pengambilan||'-'
}));

let map={};
filtered.forEach(d=>{
let k=d.barang+'|'+d.jenis+'|'+d.dana;
if(!map[k]) map[k]={Barang:d.barang,Jenis:d.jenis,Dana:d.dana,Masuk:0,Keluar:0};
if(d.tipe==='Masuk') map[k].Masuk+=d.jumlah;
if(d.tipe==='Keluar') map[k].Keluar+=d.jumlah;
});

let rekap=Object.values(map).map(r=>({
Barang:r.Barang,Jenis:r.Jenis,Dana:r.Dana,
'Total Masuk':r.Masuk,'Total Keluar':r.Keluar,Sisa:r.Masuk-r.Keluar
}));

let ws=XLSX.utils.json_to_sheet(table,{origin:'A1'});
XLSX.utils.sheet_add_json(ws,rekap,{origin:'A'+(table.length+4)});
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Inventaris');
XLSX.writeFile(wb,'Inventaris_SKB_Muara_Badak.xlsx');
}

updateAll();
</script>
</body>
</html>


