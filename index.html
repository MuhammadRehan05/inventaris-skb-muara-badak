<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris SKB Muara Badak</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8}
.container{padding:20px}
h2{margin-top:0}

table{width:100%;border-collapse:collapse;font-size:13px}
th,td{border:1px solid #444;padding:6px;text-align:center}
thead th{background:#9bbb59;color:#000;font-weight:bold}
.sub th{background:#d9d9d9}

.controls{margin-bottom:15px;display:flex;gap:10px;flex-wrap:wrap}
button{padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:bold}
.blue{background:#2563eb;color:white}
.green{background:#16a34a;color:white}

@media print{
  @page{size:landscape}
  .controls{display:none}
}
</style>
</head>

<body>
<div class="container">

<h2>Data Inventaris (Padat)</h2>

<div class="controls">
<select id="filterDana">
<option value="">Semua Dana</option>
<option>BOSKAB</option>
<option>BOP</option>
</select>

<select id="filterJenis">
<option value="">Semua Jenis</option>
<option>Barang Modal</option>
<option>BAJAS</option>
</select>

<button class="blue" onclick="downloadExcel()">â¬‡ Download Excel</button>
<button class="green" onclick="window.print()">ðŸ–¨ Cetak</button>
</div>

<table id="tabel">
<thead>
<tr>
<th rowspan="2">Tanggal</th>
<th rowspan="2">Nama Barang</th>
<th colspan="3">Barang</th>
<th rowspan="2">Pengambil</th>
<th rowspan="2">Keterangan</th>
</tr>
<tr class="sub">
<th>Masuk</th>
<th>Keluar</th>
<th>Sisa</th>
</tr>
</thead>
<tbody></tbody>
</table>

</div>

<script>
/* ===============================
   AUTO KONVERSI DATA LAMA
================================ */
let raw = JSON.parse(localStorage.getItem("inventarisData")) || [];

let data = raw.map(d=>{
  if(typeof d === "string"){
    return {
      tanggal:"",
      barang:d,
      masuk:"",
      keluar:"",
      sisa:"",
      pengambil:"",
      dana:"",
      jenis:"",
      keterangan:""
    };
  }
  return d;
});

/* ===============================
   HITUNG SISA
================================ */
let stok = {};
data.forEach(d=>{
  if(!stok[d.barang]) stok[d.barang]=0;
  if(d.masuk) stok[d.barang]+=Number(d.masuk);
  if(d.keluar) stok[d.barang]-=Number(d.keluar);
  d.sisa = stok[d.barang];
});

/* ===============================
   TAMPILKAN TABEL
================================ */
function render(){
  let tbody=document.querySelector("#tabel tbody");
  tbody.innerHTML="";

  let fDana=filterDana.value;
  let fJenis=filterJenis.value;

  data.forEach(d=>{
    if(fDana && !d.keterangan.includes(fDana)) return;
    if(fJenis && !d.keterangan.includes(fJenis)) return;

    tbody.innerHTML+=`
    <tr>
      <td>${d.tanggal||""}</td>
      <td>${d.barang}</td>
      <td>${d.masuk||""}</td>
      <td>${d.keluar||""}</td>
      <td>${d.sisa}</td>
      <td>${d.pengambil||""}</td>
      <td>${d.keterangan||""}</td>
    </tr>`;
  });
}

filterDana.onchange=render;
filterJenis.onchange=render;
render();

/* ===============================
   DOWNLOAD EXCEL (RAPI)
================================ */
function downloadExcel(){
  let rows=[];
  document.querySelectorAll("#tabel tr").forEach((tr,i)=>{
    let row=[];
    tr.querySelectorAll("th,td").forEach(td=>row.push(td.innerText));
    rows.push(row);
  });

  let ws=XLSX.utils.aoa_to_sheet(rows);

  ws["!cols"]=[
    {wch:12},{wch:30},{wch:10},{wch:10},{wch:10},{wch:20},{wch:25}
  ];

  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Inventaris");

  XLSX.writeFile(wb,"Inventaris_SKBGabungan.xlsx");
}
</script>

</body>
</html>
