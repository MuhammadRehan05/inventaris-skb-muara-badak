<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris Barang</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;padding:20px}
table{border-collapse:collapse;width:100%;background:white}
th,td{border:1px solid #444;padding:6px;font-size:13px}
th{background:#8bc34a;color:#000}
.sub th{background:#ccc}
button,select{padding:6px;margin:5px}
@media print{
  @page{size:landscape}
}
</style>
</head>

<body>

<h3>Inventaris Barang</h3>

<table>
<thead>
<tr>
  <th rowspan="2">Tanggal</th>
  <th rowspan="2">Nama Barang</th>
  <th colspan="3">Barang</th>
  <th rowspan="2">Pengambil</th>
  <th rowspan="2">Keterangan</th>
</tr>
<tr class="sub">
  <th>Masuk</th>
  <th>Keluar</th>
  <th>Sisa</th>
</tr>
</thead>
<tbody id="tabel"></tbody>
</table>

<hr>

<h4>Download Excel</h4>

<select id="filterDana">
  <option value="">Semua Dana</option>
  <option>BOP</option>
  <option>BOSKAB</option>
</select>

<select id="filterJenis">
  <option value="">Semua Jenis</option>
  <option>Barang Modal</option>
  <option>BAJAS</option>
</select>

<button onclick="downloadExcel()">â¬‡ Download Excel</button>

<script>
// ===============================
// AMAN: TIDAK MENGUBAH DATA LAMA
// ===============================
let data = JSON.parse(localStorage.getItem('data')) || [];

// TAMPILKAN TABEL
function render(){
  let map = {};
  data.forEach(d=>{
    if(!map[d.barang]){
      map[d.barang]={masuk:0,keluar:0};
    }
    if(d.tipe==='Masuk') map[d.barang].masuk+=d.jumlah;
    if(d.tipe==='Keluar') map[d.barang].keluar+=d.jumlah;
  });

  let html='';
  data.forEach(d=>{
    html+=`
    <tr>
      <td>${d.tanggal||''}</td>
      <td>${d.barang}</td>
      <td>${d.tipe==='Masuk'?d.jumlah:''}</td>
      <td>${d.tipe==='Keluar'?d.jumlah:''}</td>
      <td>${map[d.barang].masuk-map[d.barang].keluar}</td>
      <td>${d.tipe==='Keluar'?d.pengambil||'':''}</td>
      <td>${d.ket||''}</td>
    </tr>`;
  });
  document.getElementById('tabel').innerHTML=html;
}
render();

// ===============================
// DOWNLOAD EXCEL (FILTER SAJA)
// ===============================
function downloadExcel(){
  const fd = document.getElementById('filterDana').value;
  const fj = document.getElementById('filterJenis').value;

  let map={};

  data.forEach(d=>{
    if(fd && d.dana!==fd) return;
    if(fj && d.jenis!==fj) return;

    if(!map[d.barang]){
      map[d.barang]={Barang:d.barang,Masuk:0,Keluar:0};
    }
    if(d.tipe==='Masuk') map[d.barang].Masuk+=d.jumlah;
    if(d.tipe==='Keluar') map[d.barang].Keluar+=d.jumlah;
  });

  let hasil=[];
  for(let b in map){
    hasil.push({
      Barang:b,
      Masuk:map[b].Masuk,
      Keluar:map[b].Keluar,
      Sisa:map[b].Masuk-map[b].Keluar
    });
  }

  if(!hasil.length){
    alert('Data tidak ditemukan');
    return;
  }

  const ws=XLSX.utils.json_to_sheet(hasil);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Rekap');

  XLSX.writeFile(wb,'Inventaris_Final.xlsx');
}
</script>

</body>
</html>
