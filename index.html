<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris SKB Muara Badak</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;background:#f1f5f9;margin:0;padding:20px}
h2{margin-top:0}
button{padding:12px;border:none;border-radius:8px;color:#fff;font-size:16px;cursor:pointer}
.btn-masuk{background:#2563eb}
.btn-keluar{background:#dc2626}
.btn-cetak{background:#16a34a}
.btn-download{background:#1d4ed8}
.section{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;font-size:14px}
th,td{border:1px solid #333;padding:6px;text-align:center}
th{background:#9bbb59}
.sub th{background:#d9d9d9}
select,input{padding:8px;width:100%;margin:4px 0}
@media print{
  @page{size:landscape}
  button,select{display:none}
}
</style>
</head>

<body>

<div class="section">
  <button class="btn-masuk" onclick="alert('Form masuk pakai sistem lama')">Barang Masuk</button>
  <button class="btn-keluar" onclick="alert('Form keluar pakai sistem lama')">Barang Keluar</button>
  <button class="btn-cetak" onclick="window.print()">Cetak</button>
  <button class="btn-download" onclick="downloadExcel()">Download Excel</button>
</div>

<div class="section">
<h2>Data Inventaris (Padat)</h2>

<table>
<thead>
<tr>
  <th rowspan="2">Tanggal</th>
  <th rowspan="2">Nama Barang</th>
  <th colspan="3">Barang</th>
  <th rowspan="2">Pengambil</th>
  <th rowspan="2">Keterangan</th>
</tr>
<tr class="sub">
  <th>Masuk</th>
  <th>Keluar</th>
  <th>Sisa</th>
</tr>
</thead>
<tbody id="tabel"></tbody>
</table>
</div>

<div class="section">
<h3>Filter Download</h3>
<select id="filterDana">
  <option value="">Semua Dana</option>
  <option>BOSKAB 1</option>
  <option>BOSKAB 2</option>
  <option>BOP 1</option>
  <option>BOP 2</option>
</select>

<select id="filterJenis">
  <option value="">Semua Jenis</option>
  <option>Barang Modal</option>
  <option>BAJAS</option>
</select>
</div>

<script>
// ===============================
// AMBIL DATA LAMA (AMAN)
// ===============================
let raw =
  JSON.parse(localStorage.getItem('inv')) ||
  JSON.parse(localStorage.getItem('inventaris')) ||
  JSON.parse(localStorage.getItem('barangMasuk')) ||
  [];

// ===============================
// REKAP BERDASARKAN BARANG+JENIS+DANA
// ===============================
function buildRekap(data){
  let map = {};
  data.forEach(d=>{
    let barang = d.barang || d.nama_barang || '';
    let jenis  = d.jenis || '';
    let dana   = d.dana || '';
    let key = barang+'|'+jenis+'|'+dana;

    if(!map[key]){
      map[key]={barang,jenis,dana,masuk:0,keluar:0,pengambil:''};
    }

    if(d.tipe==='Masuk') map[key].masuk += Number(d.jumlah||0);
    if(d.tipe==='Keluar'){
      map[key].keluar += Number(d.jumlah||0);
      map[key].pengambil = d.pengambilan || '';
    }
  });

  return Object.values(map).map(r=>{
    r.sisa = r.masuk - r.keluar;
    return r;
  });
}

// ===============================
// RENDER TABEL
// ===============================
function render(){
  let tbody=document.getElementById('tabel');
  tbody.innerHTML='';
  buildRekap(raw).forEach(r=>{
    tbody.innerHTML+=`
    <tr>
      <td></td>
      <td>${r.barang}</td>
      <td>${r.masuk}</td>
      <td>${r.keluar}</td>
      <td>${r.sisa}</td>
      <td>${r.pengambil}</td>
      <td>${r.jenis} ${r.dana}</td>
    </tr>`;
  });
}
render();

// ===============================
// DOWNLOAD EXCEL (RAPI)
// ===============================
function downloadExcel(){
  let fDana=document.getElementById('filterDana').value;
  let fJenis=document.getElementById('filterJenis').value;

  let hasil=buildRekap(raw).filter(r=>{
    if(fDana && r.dana!==fDana) return false;
    if(fJenis && r.jenis!==fJenis) return false;
    return true;
  });

  if(!hasil.length){
    alert('Data tidak ditemukan');
    return;
  }

  let excel=hasil.map(r=>({
    Barang:r.barang,
    Masuk:r.masuk,
    Keluar:r.keluar,
    Sisa:r.sisa,
    Pengambil:r.pengambil,
    Jenis:r.jenis,
    Dana:r.dana
  }));

  let ws=XLSX.utils.json_to_sheet(excel);
  ws['!cols']=[{wpx:200},{},{},{},{},{},{}];
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Rekap Inventaris');
  XLSX.writeFile(wb,'Inventaris_SKb_Muara_Badak.xlsx');
}
</script>

</body>
</html>
