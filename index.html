<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Inventaris SKB Muara Badak</title>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f1f5f9}
.hidden{display:none}
header{background:#1e40af;color:#fff;padding:12px;display:flex;align-items:center;justify-content:space-between}
header img{height:45px;margin-right:15px}
.container{padding:20px}
.card{background:#fff;padding:20px;border-radius:12px;margin-bottom:20px;box-shadow:0 4px 10px rgba(0,0,0,.1)}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ddd;padding:8px;text-align:center}
th{background:#e5e7eb}
input,select,button{padding:8px;margin:4px;width:100%}
button{cursor:pointer;border:none;border-radius:6px}
.primary{background:#2563eb;color:white}
.danger{background:#dc2626;color:white}
.success{background:#16a34a;color:white}
.menu{display:flex;gap:10px;flex-wrap:wrap}
#loginBox{max-width:420px;margin:60px auto;background:#fff;padding:30px;border-radius:12px;text-align:center}
#loginBox img{height:90px;margin-bottom:10px}
.logoutBtn{background:#f59e0b;color:white;padding:8px;border:none;border-radius:6px;cursor:pointer}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginBox">
<img src="logo.png">
<h3>Inventaris SKB Muara Badak</h3>
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button class="primary" onclick="login()">Login</button>
</div>

<!-- APP -->
<div id="app" class="hidden">

<header>
<div style="display:flex;align-items:center">
<img src="logo.png">
<h3>Dashboard Inventaris</h3>
</div>
<button class="logoutBtn" onclick="logout()">Logout</button>
</header>

<div class="container">

<div class="card menu">
<button class="primary" onclick="show('masuk')">Barang Masuk</button>
<button class="danger" onclick="show('keluar')">Barang Keluar</button>
</div>

<!-- BARANG MASUK -->
<div class="card hidden" id="masuk">
<h3>Barang Masuk</h3>
<input id="mBarang" placeholder="Nama Barang">

<select id="mJenis">
<option>Barang Modal</option>
<option>BAJAS</option>
</select>

<select id="mDana">
<option>BOSKAB 1</option>
<option>BOSKAB 2</option>
<option>BOP 1</option>
<option>BOP 2</option>
<option>Dana Lainnya</option>
</select>

<input type="number" id="mJumlah" placeholder="Jumlah">

<select id="mSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>lusin</option>
<option>Botol</option><option>Paket</option>
<option>Unit</option><option>Meter</option>
</select>

<button class="success" onclick="masukBarang()">Simpan</button>
</div>

<!-- BARANG KELUAR -->
<div class="card hidden" id="keluar">
<h3>Barang Keluar</h3>

<select id="kBarang"></select>
<input type="number" id="kJumlah" placeholder="Jumlah">

<select id="kSatuan">
<option>rim</option><option>buah</option><option>pcs</option>
<option>pack</option><option>kotak</option><option>biji</option>
<option>set</option><option>lusin</option>
<option>Botol</option><option>Paket</option>
<option>Unit</option><option>Meter</option>
</select>

<select id="kJenis"></select>
<select id="kDana"></select>

<select id="kAmbil">
<option>Bu Munawarah. S.Pd</option>
<option>Bu Liliana Sataria. S.Kom</option>
<option>Bu Fatimah. S.Pd</option>
<option>Bu Fitriyana. S.Pd</option>
<option>Bu Hirda Yulinalmi</option>
<option>Bu Dwi Rika. S.Pd</option>
<option>Bu Uut</option>
<option>Pak Heri Sadiman. S.Pd</option>
<option>Pak Jemidin. S.Pd., M.Pd</option>
<option>Pak Rehan</option>
</select>

<button class="danger" onclick="keluarBarang()">Simpan</button>
</div>

<!-- REKAP -->
<div class="card">
<h3>Rekap Stok</h3>
<table id="rekap"></table>
</div>

<!-- DATA -->
<div class="card">
<h3>Data Inventaris</h3>
<table id="tabel"></table>
</div>

<!-- DOWNLOAD -->
<div class="card">
<h3>Download Excel</h3>

<select id="fTipe">
<option value="">Semua</option>
<option value="Masuk">Barang Masuk</option>
<option value="Keluar">Barang Keluar</option>
</select>

<select id="fJenis">
<option value="">Semua Jenis</option>
</select>

<select id="fDana">
<option value="">Semua Dana</option>
</select>

<button class="primary" onclick="downloadExcel()">Download Excel</button>
</div>

</div>
</div>

<script>
const akun=[{u:'admin',p:'123'},{u:'operator',p:'123'}];
let data = JSON.parse(localStorage.getItem('inv')) || [];

/* LOGIN */
function login(){
if(!akun.find(a=>a.u===user.value&&a.p===pass.value)) return alert('Login gagal');
loginBox.style.display='none';
app.classList.remove('hidden');
updateAll();
}
function logout(){
loginBox.style.display='block';
app.classList.add('hidden');
}

/* UI */
function show(id){
masuk.classList.add('hidden');
keluar.classList.add('hidden');
document.getElementById(id).classList.remove('hidden');
}

/* STOK AKURAT */
function stok(barang,jenis,dana){
let m=0,k=0;
data.forEach(d=>{
if(d.barang===barang && d.jenis===jenis && d.dana===dana){
if(d.tipe==='Masuk') m+=d.jumlah;
if(d.tipe==='Keluar') k+=d.jumlah;
}
});
return m-k;
}

/* MASUK */
function masukBarang(){
if(!mBarang.value||!mJumlah.value) return alert('Lengkapi data');
data.push({
tipe:'Masuk',
barang:mBarang.value,
jumlah:+mJumlah.value,
satuan:mSatuan.value,
jenis:mJenis.value,
dana:mDana.value,
pengambilan:''
});
localStorage.setItem('inv',JSON.stringify(data));
mBarang.value='';mJumlah.value='';
updateAll();
}

/* KELUAR */
function keluarBarang(){
if(+kJumlah.value>stok(kBarang.value,kJenis.value,kDana.value))
return alert('Stok tidak cukup');
data.push({
tipe:'Keluar',
barang:kBarang.value,
jumlah:+kJumlah.value,
satuan:kSatuan.value,
jenis:kJenis.value,
dana:kDana.value,
pengambilan:kAmbil.value
});
localStorage.setItem('inv',JSON.stringify(data));
kJumlah.value='';
updateAll();
}

/* UPDATE */
function updateAll(){
updateDropdown();
updateRekap();
updateTabel();
updateFilter();
}

function updateDropdown(){
kBarang.innerHTML='';
kJenis.innerHTML='';
kDana.innerHTML='';
[...new Set(data.map(d=>d.barang))].forEach(v=>kBarang.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.jenis))].forEach(v=>kJenis.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.dana))].forEach(v=>kDana.innerHTML+=`<option>${v}</option>`);
}

function updateRekap(){
let r='<tr><th>Barang</th><th>Jenis</th><th>Dana</th><th>Sisa</th></tr>';
let map={};
data.forEach(d=>{
let k=d.barang+'|'+d.jenis+'|'+d.dana;
if(!map[k]){
map[k]=true;
r+=`<tr><td>${d.barang}</td><td>${d.jenis}</td><td>${d.dana}</td><td>${stok(d.barang,d.jenis,d.dana)}</td></tr>`;
}
});
rekap.innerHTML=r;
}

function updateTabel(){
let t='<tr><th>No</th><th>Tipe</th><th>Barang</th><th>Jumlah</th><th>Satuan</th><th>Jenis</th><th>Dana</th><th>Pengambilan</th></tr>';
data.forEach((d,i)=>{
t+=`<tr><td>${i+1}</td><td>${d.tipe}</td><td>${d.barang}</td><td>${d.jumlah}</td><td>${d.satuan}</td><td>${d.jenis}</td><td>${d.dana}</td><td>${d.pengambilan||'-'}</td></tr>`;
});
tabel.innerHTML=t;
}

function updateFilter(){
fJenis.innerHTML='<option value="">Semua Jenis</option>';
fDana.innerHTML='<option value="">Semua Dana</option>';
[...new Set(data.map(d=>d.jenis))].forEach(v=>fJenis.innerHTML+=`<option>${v}</option>`);
[...new Set(data.map(d=>d.dana))].forEach(v=>fDana.innerHTML+=`<option>${v}</option>`);
}

/* DOWNLOAD EXCEL + REKAP */
function downloadExcel(){
let filtered=data.filter(d=>
(!fTipe.value||d.tipe===fTipe.value)&&
(!fJenis.value||d.jenis===fJenis.value)&&
(!fDana.value||d.dana===fDana.value)
);
if(!filtered.length) return alert('Data kosong');

let table=filtered.map((d,i)=>({
No:i+1,Tipe:d.tipe,Barang:d.barang,Jumlah:d.jumlah,
Satuan:d.satuan,Jenis:d.jenis,Dana:d.dana,Pengambilan:d.pengambilan||'-'
}));

let map={};
filtered.forEach(d=>{
let k=d.barang+'|'+d.jenis+'|'+d.dana;
if(!map[k]) map[k]={Barang:d.barang,Jenis:d.jenis,Dana:d.dana,Masuk:0,Keluar:0};
if(d.tipe==='Masuk') map[k].Masuk+=d.jumlah;
if(d.tipe==='Keluar') map[k].Keluar+=d.jumlah;
});

let rekap=Object.values(map).map(r=>({
Barang:r.Barang,Jenis:r.Jenis,Dana:r.Dana,
'Total Masuk':r.Masuk,'Total Keluar':r.Keluar,Sisa:r.Masuk-r.Keluar
}));

let ws=XLSX.utils.json_to_sheet(table,{origin:'A1'});
XLSX.utils.sheet_add_json(ws,rekap,{origin:'A'+(table.length+4)});
let wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,'Inventaris');
XLSX.writeFile(wb,'Inventaris_SKB_Muara_Badak.xlsx');
}

updateAll();
</script>
</body>
</html>
